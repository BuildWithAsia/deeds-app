<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deeds | Admin Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css"
      integrity="sha384-4VhpjS/4jGouVp21Hb+Jseb3CidRubc4QpfAlWTMwVzKhI6+w4n1vCtbmZh9rqxW"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../styles.css" />
    <style>
      .admin-badge {
        background-color: rgba(250, 204, 21, 0.2);
        color: #facc15;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid rgba(250, 204, 21, 0.3);
      }
      .stat-card {
        background: rgba(10, 17, 40, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 1.25rem;
        padding: 1.5rem;
        box-shadow: 0 1rem 2rem rgba(4, 6, 18, 0.5);
        backdrop-filter: blur(10px);
        transition: all 200ms ease;
      }
      .stat-card:hover {
        transform: translateY(-2px);
        border-color: rgba(250, 204, 21, 0.5);
      }
      .stat-card::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: radial-gradient(
          circle at top right,
          rgba(250, 204, 21, 0.2),
          transparent 60%
        );
        pointer-events: none;
      }
      .gradient-title {
        background: linear-gradient(120deg, #facc15 0%, #f97316 40%, #22c55e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: clamp(1.8rem, 3vw, 2.5rem);
        font-weight: 700;
        margin: 0;
      }
      .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: rgba(248, 250, 252, 0.95);
        margin: 0.75rem 0;
      }
      .stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(248, 250, 252, 0.6);
      }
      .action-card {
        background: rgba(15, 23, 42, 0.65);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 1rem;
        padding: 1.5rem;
        transition: all 200ms ease;
        cursor: pointer;
        text-decoration: none;
        display: block;
      }
      .action-card:hover {
        transform: translateY(-2px);
        border-color: rgba(250, 204, 21, 0.5);
        box-shadow: 0 1rem 2rem rgba(250, 204, 21, 0.2);
      }
      .activity-table {
        width: 100%;
        border-collapse: collapse;
      }
      .activity-table th {
        text-align: left;
        padding: 0.75rem 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(248, 250, 252, 0.5);
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }
      .activity-table td {
        padding: 1rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        color: rgba(248, 250, 252, 0.85);
      }
      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .status-verified {
        background-color: rgba(34, 197, 94, 0.2);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
      }
      .status-pending {
        background-color: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
        border: 1px solid rgba(251, 191, 36, 0.3);
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="landing-body">
    <!-- Navigation Bar -->
    <nav class="top-nav">
      <div class="nav-brand-container">
        <a href="dashboard.html" class="nav-back-link" aria-label="Admin Dashboard">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="nav-back-icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
          </svg>
        </a>
        <span class="nav-brand-text">Deeds</span>
        <span class="admin-badge">Admin</span>
      </div>

      <div class="nav-lang-switcher">
        <a href="verify.html" class="landing-tag">Verification Queue</a>
        <a href="../dashboard.html" class="landing-tag">User View</a>
        <a href="../leaderboard.html" class="landing-tag">Leaderboard</a>
        <button
          type="button"
          class="landing-tag"
          data-action="logout"
        >
          Log out
        </button>
      </div>
    </nav>

    <main style="max-width: 72rem; margin: 0 auto; padding: clamp(2rem, 4vw, 3rem); width: 100%;">
      <!-- Welcome Section -->
      <div class="mb-8 flex flex-wrap items-start justify-between gap-4">
        <div>
          <h1 class="gradient-title mb-3">
            Admin Dashboard
          </h1>
          <p style="color: rgba(248, 250, 252, 0.75); font-size: 1.125rem; max-width: 42rem;">
            Manage deeds verification, view analytics, and oversee community activity.
          </p>
        </div>
        <button
          type="button"
          onclick="handleManualRefresh()"
          id="refresh-button"
          class="landing-tag"
          style="display: inline-flex; align-items: center; gap: 0.5rem;"
          title="Refresh dashboard data"
        >
          <svg id="refresh-icon" class="h-4 w-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <span id="refresh-text">Refresh</span>
        </button>
      </div>

      <!-- Stats Overview -->
      <div class="grid gap-6 md:grid-cols-3 mb-8">
        <!-- Pending Deeds -->
        <div class="stat-card" style="position: relative;">
          <p class="stat-label">‚è± Pending Deeds</p>
          <p class="stat-value" data-stat="pending">-</p>
          <p class="stat-label">Awaiting verification</p>
        </div>

        <!-- Total Verified -->
        <div class="stat-card" style="position: relative;">
          <p class="stat-label">‚úì Verified Deeds</p>
          <p class="stat-value" data-stat="verified">-</p>
          <p class="stat-label">Total approved</p>
        </div>

        <!-- Total Users -->
        <div class="stat-card" style="position: relative;">
          <p class="stat-label">üë• Active Users</p>
          <p class="stat-value" data-stat="users">-</p>
          <p class="stat-label">Community members</p>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="grid gap-6 md:grid-cols-2 mb-8">
        <!-- Verification Queue -->
        <a href="verify.html" class="action-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: #facc15;">
              Verification Queue
            </h3>
            <svg style="width: 1.5rem; height: 1.5rem; color: #facc15;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </div>
          <p style="color: rgba(248, 250, 252, 0.75); margin-bottom: 1rem;">
            Review and approve pending deed submissions from community members.
          </p>
          <span class="admin-badge">
            <span data-stat="pending">0</span> pending
          </span>
        </a>

        <!-- Analytics -->
        <div class="action-card" style="opacity: 0.6; cursor: default;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: 600; color: rgba(248, 250, 252, 0.75);">
              Analytics
            </h3>
            <span style="background: rgba(148, 163, 184, 0.2); color: rgba(248, 250, 252, 0.5); padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">
              Coming Soon
            </span>
          </div>
          <p style="color: rgba(248, 250, 252, 0.5); margin-bottom: 1rem;">
            View detailed reports on community engagement, verification trends, and impact metrics.
          </p>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="stat-card" style="position: relative; padding: 2rem;">
        <h3 style="font-size: 1.5rem; font-weight: 700; color: rgba(248, 250, 252, 0.95); margin-bottom: 1.5rem;">
          Recent Deeds
        </h3>
        <div style="overflow-x: auto;">
          <table class="activity-table">
            <thead>
              <tr>
                <th>Deed</th>
                <th>User</th>
                <th>Status</th>
                <th>Submitted</th>
              </tr>
            </thead>
            <tbody data-recent-deeds>
              <tr>
                <td colspan="4" style="padding: 3rem; text-align: center;">
                  <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                    <div style="width: 2rem; height: 2rem; border: 3px solid rgba(250, 204, 21, 0.3); border-top-color: #facc15; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span style="color: rgba(248, 250, 252, 0.5);">Loading recent activity...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      </main>
    </div>

    <script src="../script.js" defer></script>
    <script src="admin-core.js" defer></script>
    <script>
      // Admin dashboard logic with auto-refresh
      let autoRefresher = null;
      let isRefreshing = false;

      async function handleManualRefresh() {
        if (isRefreshing) return;

        isRefreshing = true;
        const button = document.getElementById('refresh-button');
        const icon = document.getElementById('refresh-icon');
        const text = document.getElementById('refresh-text');

        button.disabled = true;
        icon.classList.add('animate-spin');
        text.textContent = 'Refreshing...';

        try {
          await loadAdminStats();
        } finally {
          setTimeout(() => {
            button.disabled = false;
            icon.classList.remove('animate-spin');
            text.textContent = 'Refresh';
            isRefreshing = false;
          }, 500);
        }
      }

      async function loadAdminStats() {
        try {
          // Show loading states
          document.querySelectorAll('[data-stat]').forEach((el) => {
            el.textContent = '...';
          });

          // Fetch all deeds with authentication using adminFetch
          const deedsResponse = await adminFetch("/api/deeds?status=all");
          const deeds = await deedsResponse.json();

          // Fetch leaderboard for user count
          const leaderboardResponse = await fetch("/api/leaderboard");
          const users = await leaderboardResponse.json();

          // Calculate stats
          const pending = deeds.filter((d) => d.status === "pending").length;
          const verified = deeds.filter((d) => d.status === "verified").length;
          const userCount = users.length;

          // Update stats
          document.querySelectorAll('[data-stat="pending"]').forEach((el) => {
            el.textContent = pending;
          });
          document.querySelectorAll('[data-stat="verified"]').forEach((el) => {
            el.textContent = verified;
          });
          document.querySelectorAll('[data-stat="users"]').forEach((el) => {
            el.textContent = userCount;
          });

          // Render recent deeds
          renderRecentDeeds(deeds.slice(0, 10));

          // Show success toast on first load
          if (!autoRefresher) {
            toastManager.success(`Dashboard loaded: ${pending} pending, ${verified} verified deeds`, 3000);
          }
        } catch (error) {
          console.error("Failed to load admin stats:", error);
          toastManager.error("Failed to load dashboard data. Please refresh the page.");

          // Reset stats to dash on error
          document.querySelectorAll('[data-stat]').forEach((el) => {
            el.textContent = '-';
          });
        }
      }

      function renderRecentDeeds(deeds) {
        const tbody = document.querySelector("[data-recent-deeds]");
        if (!tbody) return;

        if (!deeds || deeds.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4" style="padding: 3rem; text-align: center;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                  <svg style="width: 4rem; height: 4rem; color: rgba(248, 250, 252, 0.3);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <p style="font-size: 1.125rem; font-weight: 600; color: rgba(248, 250, 252, 0.75);">No deeds yet</p>
                  <p style="font-size: 0.875rem; color: rgba(248, 250, 252, 0.5);">Deeds will appear here as they are submitted</p>
                </div>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = deeds
          .map(
            (deed) => `
          <tr>
            <td style="font-weight: 500; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${deed.title}">${deed.title}</td>
            <td>${deed.user_name}</td>
            <td>
              <span class="status-badge ${deed.status === "verified" ? "status-verified" : "status-pending"}">
                ${deed.status === "verified" ? "‚úì Verified" : "‚è± Pending"}
              </span>
            </td>
            <td style="color: rgba(248, 250, 252, 0.6);">${new Date(deed.created_at).toLocaleDateString()}</td>
          </tr>
        `,
          )
          .join("");
      }

      // Load stats on page load and setup auto-refresh
      document.addEventListener("DOMContentLoaded", () => {
        loadAdminStats();

        // Auto-refresh every 30 seconds
        autoRefresher = new AutoRefresh(loadAdminStats, 30000);
        autoRefresher.start();

        console.log('[Admin Dashboard] Auto-refresh enabled (30s interval)');
      });
    </script>
  </body>
</html>
